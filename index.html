<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Misi Robot Logika - Simulasi Berpikir Komputasional</title>
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Font kustom untuk tampilan yang lebih menarik */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Press+Start+2P&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            overflow-x: hidden; /* Mencegah scrolling horizontal */
            overflow-y: auto; /* Izinkan scroll vertikal jika perlu */
        }
        
        .font-pixel {
            font-family: 'Press Start 2P', cursive;
        }

        /* Style untuk grid game */
        #game-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            grid-template-rows: repeat(10, 1fr);
            width: 100%;
            height: 100%;
            border: 4px solid #374151; /* gray-700 */
            background-color: #f3f4f6; /* gray-100 */
            aspect-ratio: 1 / 1; /* Menjaga rasio 1:1 */
        }

        /* Style untuk sel di grid */
        .grid-cell {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem; /* Ukuran emoji */
            border: 1px solid #d1d5db; /* gray-300 */
            transition: all 0.3s ease;
        }

        /* Transisi untuk robot */
        #player {
            transition: transform 0.3s linear, opacity 0.3s;
            z-index: 10;
        }

        /* Tampilan perintah di antrian */
        .command-item {
            animation: pop-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes pop-in {
            0% {
                opacity: 0;
                transform: scale(0.5);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        /* Tombol Gemini */
        .btn-gemini {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .btn-gemini:hover {
            background-color: #4338ca; /* indigo-700 */
        }
        .btn-gemini:disabled {
            background-color: #6b7280; /* gray-500 */
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* Animasi Loader */
        .loader {
            width: 24px;
            height: 24px;
            border: 4px solid #FFF;
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
            margin: 1rem auto;
        }

        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Style untuk tombol perintah agar seragam */
        .btn-command {
            color: white;
            font-weight: 700;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center p-4">

    <div class="container mx-auto max-w-7xl w-full">
        <h1 class="font-pixel text-3xl md:text-5xl text-center text-yellow-400 mb-6 drop-shadow-[0_2px_2px_rgba(0,0,0,0.8)]">
            Misi Robot Logika
        </h1>

        <div class="flex flex-col md:flex-row gap-6 bg-gray-800 p-4 md:p-8 rounded-2xl shadow-2xl border-4 border-gray-700">

            <!-- Kolom Kiri: Peta Game -->
            <div class="w-full md:w-1/2 lg:w-3/5">
                <div id="game-container" class="relative max-w-lg mx-auto aspect-square">
                    <div id="game-grid"></div>
                    <!-- Player (Robot) akan diposisikan secara absolut di atas grid -->
                    <div id="player" class="grid-cell absolute top-0 left-0" style="transform: translate(0px, 0px) rotate(0deg);">ü§ñ</div>
                </div>
            </div>

            <!-- Kolom Kanan: Kontrol & Instruksi -->
            <div class="w-full md:w-1/2 lg:w-2/5 flex flex-col">
                
                <!-- Box Instruksi Level -->
                <div id="instructions" class="bg-gray-700 p-4 rounded-lg mb-4 border-l-4 border-yellow-400">
                    <h2 class="text-xl font-bold font-pixel text-yellow-400 mb-2">Level 1: Algoritma</h2>
                    <p id="level-description" class="text-gray-200 mb-4">
                        Selamat datang! <strong class="text-white">ALGORITMA</strong> adalah urutan instruksi langkah demi langkah. Buat algoritma untuk memandu robot (ü§ñ) ke bendera (üèÅ).
                    </p>
                    
                    <!-- FITUR GEMINI 1: Penjelasan Konsep -->
                    <button id="btn-explain-concept" class="btn-gemini text-sm w-full">
                        ‚ú® Jelaskan Konsep Ini
                    </button>
                    <div id="gemini-explanation" class="hidden mt-3 bg-gray-800 p-3 rounded-md text-sm text-gray-300 italic">
                        <div class="loader hidden"></div>
                        <p id="explanation-text"></p>
                    </div>
                </div>

                <!-- Box Perintah yang Tersedia -->
                <div class="mb-4">
                    <h3 class="text-lg font-semibold mb-3 text-gray-300">Perintah Tersedia:</h3>
                    <div class="flex flex-wrap gap-3">
                        <button id="btn-maju" class="btn-command bg-blue-600 hover:bg-blue-700">Maju</button>
                        <button id="btn-kiri" class="btn-command bg-green-600 hover:bg-green-700">Putar Kiri</button>
                        <button id="btn-kanan" class="btn-command bg-green-600 hover:bg-green-700">Putar Kanan</button>
                    </div>
                </div>

                <!-- Box Antrian Perintah -->
                <div class="flex-grow bg-gray-900 p-4 rounded-lg shadow-inner min-h-[150px] mb-4">
                    <h3 class="text-lg font-semibold mb-3 text-gray-300">Antrian Perintah:</h3>
                    <div id="command-queue" class="flex flex-wrap gap-2">
                        <!-- Perintah akan ditambahkan di sini oleh JS -->
                    </div>
                </div>

                <!-- Tombol Kontrol Utama -->
                <div class="flex flex-col sm:flex-row gap-3">
                    <button id="btn-run" class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 px-6 rounded-lg text-lg transform transition hover:scale-105 shadow-lg">
                        JALANKAN
                    </button>
                    <button id="btn-reset" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition hover:bg-red-500">
                        ATUR ULANG
                    </button>
                </div>
            </div>

        </div>
    </div>

    <!-- Modal untuk Pesan Kemenangan/Kegagalan -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden transition-opacity duration-300">
        <div id="modal-content" class="bg-gray-800 p-8 rounded-2xl shadow-xl border-4 border-gray-700 text-center max-w-sm w-full transform transition-all scale-95 opacity-0">
            <h2 id="modal-title" class="font-pixel text-3xl mb-4"></h2>
            <p id="modal-message" class="text-gray-200 text-lg mb-6"></p>
            
            <!-- FITUR GEMINI 2: Analisis Solusi -->
            <button id="btn-analyze-solution" class="btn-gemini w-full mb-3 hidden">
                ‚ú® Analisis Solusiku
            </button>
            <div id="gemini-analysis" class="hidden mb-3 bg-gray-900 p-3 rounded-md text-sm text-gray-300 italic text-left">
                <div class="loader hidden"></div>
                <p id="analysis-text"></p>
            </div>

            <button id="btn-next-level" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 px-6 rounded-lg text-lg w-full">
                Level Selanjutnya
            </button>
            <button id="btn-retry" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg text-lg w-full mt-3 hidden">
                Coba Lagi
            </button>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // === 1. DEFINISI STATE GAME ===

            // Kunci API (kosongkan, akan diisi oleh runtime)
            const apiKey = ""; // JANGAN DIISI: Biarkan kosong

            const gameGrid = document.getElementById('game-grid');
            const playerElement = document.getElementById('player');
            const commandQueueElement = document.getElementById('command-queue');
            
            // Tombol Perintah
            const btnMaju = document.getElementById('btn-maju');
            const btnKiri = document.getElementById('btn-kiri');
            const btnKanan = document.getElementById('btn-kanan');
            
            // Tombol Kontrol
            const btnRun = document.getElementById('btn-run');
            const btnReset = document.getElementById('btn-reset');
            
            // UI Teks
            const levelTitle = document.querySelector('#instructions h2');
            const levelDescription = document.getElementById('level-description');

            // Modal
            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');
            const modalTitle = document.getElementById('modal-title');
            const modalMessage = document.getElementById('modal-message');
            const btnNextLevel = document.getElementById('btn-next-level');
            const btnRetry = document.getElementById('btn-retry');

            // --- Fitur Gemini Baru ---
            const btnExplainConcept = document.getElementById('btn-explain-concept');
            const geminiExplanation = document.getElementById('gemini-explanation');
            const explanationText = document.getElementById('explanation-text');
            const btnAnalyzeSolution = document.getElementById('btn-analyze-solution');
            const geminiAnalysis = document.getElementById('gemini-analysis');
            const analysisText = document.getElementById('analysis-text');

            // Ukuran grid (10x10)
            const gridSize = 10;
            let cellSize = 0; // Akan dihitung saat render

            // State Game
            let currentLevel = 0;
            let playerPos = { x: 0, y: 0 };
            let playerDir = 0; // 0: atas, 1: kanan, 2: bawah, 3: kiri
            let commandQueue = [];
            let isExecuting = false;

            // Definisi Level (Peta & Konsep CT)
            // 0: Kosong, 1: Dinding (üß±), 2: Bendera (üèÅ), 3: Kunci (üîë), 4: Pintu (üö™), 5: Air (üíß), 6: Lumpur (üü´)
            const levels = [
                {
                    // LEVEL 1: Algoritma
                    title: "Level 1: Algoritma",
                    concept: "Algoritma",
                    description: "Selamat datang! <strong class='text-white'>ALGORITMA</strong> adalah urutan instruksi langkah demi langkah. Buat algoritma untuk memandu robot (ü§ñ) ke bendera (üèÅ).",
                    startPos: { x: 4, y: 8 },
                    startDir: 0,
                    grid: [
                        [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
                        [1, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                        [1, 0, 0, 0, 1, 1, 1, 0, 0, 1],
                        [1, 0, 0, 0, 1, 2, 1, 0, 0, 1],
                        [1, 0, 0, 0, 1, 0, 1, 0, 0, 1],
                        [1, 0, 0, 0, 1, 0, 1, 0, 0, 1],
                        [1, 0, 1, 1, 1, 0, 1, 1, 0, 1],
                        [1, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                        [1, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                        [1, 1, 1, 1, 1, 1, 1, 1, 1, 1]
                    ]
                },
                {
                    // LEVEL 2: Dekomposisi
                    title: "Level 2: Dekomposisi",
                    concept: "Dekomposisi",
                    description: "<strong class='text-white'>DEKOMPOSISI</strong> adalah memecah masalah besar menjadi bagian-bagian kecil. <br>1. Ambil kunci (üîë). <br>2. Buka pintu (üö™) untuk mencapai bendera (üèÅ).",
                    startPos: { x: 1, y: 8 },
                    startDir: 0,
                    grid: [
                        [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
                        [1, 0, 0, 0, 1, 0, 0, 0, 2, 1],
                        [1, 0, 0, 0, 1, 0, 0, 0, 4, 1],
                        [1, 0, 0, 0, 1, 0, 0, 0, 1, 1],
                        [1, 1, 1, 1, 1, 0, 0, 0, 0, 1],
                        [1, 3, 0, 0, 0, 0, 0, 0, 0, 1],
                        [1, 1, 1, 1, 1, 1, 1, 1, 0, 1],
                        [1, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                        [1, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                        [1, 1, 1, 1, 1, 1, 1, 1, 1, 1]
                    ]
                },
                {
                    // LEVEL 3: Pengenalan Pola
                    title: "Level 3: Pengenalan Pola",
                    concept: "Pengenalan Pola",
                    description: "Lihat jalurnya? Ada <strong class='text-white'>POLA</strong> yang berulang. Anda harus mengulang 'Maju', 'Maju', 'Putar Kanan' sebanyak 3 kali. Sayang sekali tombol 'Ulangi' rusak! Lakukan secara manual untuk merasakan polanya.",
                    startPos: { x: 2, y: 7 },
                    startDir: 0,
                    grid: [
                        [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
                        [1, 1, 1, 1, 1, 1, 1, 2, 1, 1],
                        [1, 1, 0, 0, 1, 1, 0, 0, 1, 1],
                        [1, 1, 0, 0, 1, 1, 0, 0, 1, 1],
                        [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
                        [1, 1, 0, 0, 1, 1, 0, 0, 1, 1],
                        [1, 1, 0, 0, 1, 1, 0, 0, 1, 1],
                        [1, 1, 0, 1, 1, 1, 1, 1, 1, 1],
                        [1, 1, 0, 0, 0, 0, 0, 0, 0, 1],
                        [1, 1, 1, 1, 1, 1, 1, 1, 1, 1]
                    ]
                },
                {
                    // LEVEL 4: Abstraksi
                    title: "Level 4: Abstraksi",
                    concept: "Abstraksi",
                    description: "<strong class='text-white'>ABSTRAKSI</strong> adalah fokus pada hal penting & mengabaikan detail tidak relevan. Robot Anda anti-lumpur (üü´) tapi TIDAK anti-air (üíß). <br>Abaikan lumpur, hindari air, capai bendera!",
                    startPos: { x: 1, y: 8 },
                    startDir: 0,
                    grid: [
                        [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
                        [1, 0, 0, 0, 5, 5, 0, 0, 2, 1],
                        [1, 0, 6, 0, 5, 5, 0, 6, 0, 1],
                        [1, 0, 6, 0, 0, 0, 0, 6, 0, 1],
                        [1, 0, 6, 6, 6, 6, 6, 6, 0, 1],
                        [1, 0, 0, 0, 5, 5, 0, 0, 0, 1],
                        [1, 0, 6, 0, 5, 5, 0, 6, 0, 1],
                        [1, 0, 6, 0, 0, 0, 0, 6, 0, 1],
                        [1, 0, 6, 6, 6, 6, 6, 6, 0, 1],
                        [1, 1, 1, 1, 1, 1, 1, 1, 1, 1]
                    ]
                }
            ];

            const gridEmojis = {
                0: '', // Kosong
                1: 'üß±', // Dinding
                2: 'üèÅ', // Bendera
                3: 'üîë', // Kunci
                4: 'üö™', // Pintu
                5: 'üíß', // Air
                6: 'üü´'  // Lumpur
            };

            // === 2. FUNGSI INTI GAME ===

            /**
             * Memuat dan merender level baru
             */
            function loadLevel(levelIndex) {
                if (levelIndex >= levels.length) {
                    showModal("SELESAI!", "Kerja bagus! Anda telah menguasai semua dasar Berpikir Komputasional!", false);
                    btnNextLevel.classList.add('hidden');
                    return;
                }

                const level = levels[levelIndex];
                currentLevel = levelIndex;
                commandQueue = [];
                isExecuting = false;

                // BUG FIX: Pastikan grid kembali ke kondisi asli saat load
                // Simpan grid asli saat pertama kali load
                if (!level.originalGrid) {
                    level.originalGrid = JSON.parse(JSON.stringify(level.grid));
                } else {
                    // Reset grid ke aslinya jika sudah dimodifikasi (misal: pintu terbuka)
                    level.grid = JSON.parse(JSON.stringify(level.originalGrid));
                }
                
                // Reset UI
                levelTitle.innerText = level.title;
                levelDescription.innerHTML = level.description;
                commandQueueElement.innerHTML = '';
                toggleControls(true);

                // Reset UI Gemini
                geminiExplanation.classList.add('hidden');
                explanationText.innerHTML = '';
                btnExplainConcept.disabled = false;

                // Render Peta
                gameGrid.innerHTML = '';
                
                // BUG FIX: Gunakan requestAnimationFrame untuk memastikan layout sudah dihitung
                requestAnimationFrame(() => {
                    const gridContainerWidth = gameGrid.clientWidth;
                    if (gridContainerWidth === 0) {
                        console.error("Game grid width is 0. Retrying render.");
                        // Coba lagi jika gagal
                        setTimeout(() => loadLevel(levelIndex), 100);
                        return;
                    }

                    // Sukses, hitung cellSize
                    cellSize = gridContainerWidth / gridSize;

                    for (let y = 0; y < gridSize; y++) {
                        for (let x = 0; x < gridSize; x++) {
                            const cell = document.createElement('div');
                            cell.classList.add('grid-cell');
                            const cellType = level.grid[y][x];
                            cell.innerHTML = gridEmojis[cellType] || '';
                            
                            // Beri warna latar berbeda untuk non-wall
                            if(cellType === 0) cell.style.backgroundColor = '#ffffff'; // putih
                            if(cellType === 5) cell.style.backgroundColor = '#3b82f6'; // blue-500
                            if(cellType === 6) cell.style.backgroundColor = '#7f5539'; // coklat lumpur

                            gameGrid.appendChild(cell);
                        }
                    }
                    
                    // Reset State Player (PINDAHKAN KE DALAM rAF)
                    playerPos = { ...level.startPos };
                    playerDir = level.startDir;
                    updatePlayerPosition();
                });
            }

            /**
             * Memperbarui posisi dan rotasi robot di UI
             */
            function updatePlayerPosition() {
                // BUG FIX: Cek jika cellSize 0
                if (cellSize === 0) {
                    const gridContainerWidth = gameGrid.clientWidth;
                    if (gridContainerWidth > 0) {
                        cellSize = gridContainerWidth / gridSize;
                    } else {
                        console.warn("Cannot update player position, cellSize is 0.");
                        return; // Jangan update jika size 0
                    }
                }

                const x = playerPos.x * cellSize;
                const y = playerPos.y * cellSize;
                const rotation = playerDir * 90; // 0: 0deg, 1: 90deg, 2: 180deg, 3: 270deg
                
                playerElement.style.width = `${cellSize}px`;
                playerElement.style.height = `${cellSize}px`;
                playerElement.style.transform = `translate(${x}px, ${y}px) rotate(${rotation}deg)`;
            }

            /**
             * Menambahkan perintah ke antrian
             */
            function addCommand(command) {
                if (isExecuting) return;

                commandQueue.push(command);
                
                const commandDiv = document.createElement('div');
                commandDiv.classList.add('command-item', 'p-2', 'rounded', 'font-semibold', 'text-sm');
                
                switch(command) {
                    case 'maju':
                        commandDiv.classList.add('bg-blue-600', 'text-white');
                        commandDiv.innerText = 'Maju';
                        break;
                    case 'kiri':
                        commandDiv.classList.add('bg-green-600', 'text-white');
                        commandDiv.innerText = 'Kiri';
                        break;
                    case 'kanan':
                        commandDiv.classList.add('bg-green-600', 'text-white');
                        commandDiv.innerText = 'Kanan';
                        break;
                }
                commandQueueElement.appendChild(commandDiv);
            }

            /**
             * Mereset antrian perintah dan posisi robot
             */
            function resetGame() {
                commandQueue = [];
                commandQueueElement.innerHTML = '';
                isExecuting = false;
                
                // BUG FIX: Cukup panggil loadLevel,
                // karena loadLevel sekarang menangani reset grid
                loadLevel(currentLevel);
                
                toggleControls(true); // Pastikan kontrol aktif
            }

            /**
             * Menjalankan semua perintah di antrian
             */
            async function executeCommands() {
                if (isExecuting) return;
                isExecuting = true;
                toggleControls(false);

                // Variabel untuk state level
                let hasKey = false;
                // PENTING: Mutasi grid saat ini, resetGame akan mengembalikannya
                const levelData = levels[currentLevel].grid; 

                const sleep = (ms) => new Promise(res => setTimeout(res, ms));

                for (const command of commandQueue) {
                    await sleep(400); // Jeda antar perintah

                    switch(command) {
                        case 'maju':
                            const { dx, dy } = getDirectionVector();
                            const nextX = playerPos.x + dx;
                            const nextY = playerPos.y + dy;

                            // Cek batasan grid
                            if (nextX < 0 || nextX >= gridSize || nextY < 0 || nextY >= gridSize) {
                                failExecution("Robot menabrak batas arena!");
                                return;
                            }

                            const nextCell = levelData[nextY][nextX];
                            
                            // Logika Cek Tabrakan
                            switch(nextCell) {
                                case 1: // Dinding
                                    failExecution("Robot menabrak dinding! (üß±)");
                                    return;
                                case 5: // Air
                                    failExecution("Robot masuk air! (üíß) Game Over!");
                                    return;
                                case 4: // Pintu
                                    if (hasKey) {
                                        levelData[nextY][nextX] = 0; // Pintu terbuka
                                        gameGrid.children[nextY * gridSize + nextX].innerHTML = ''; // Hapus emoji pintu
                                        playerPos = { x: nextX, y: nextY };
                                    } else {
                                        failExecution("Pintu (üö™) terkunci! Butuh kunci (üîë).");
                                        return;
                                    }
                                    break;
                                case 3: // Kunci
                                    hasKey = true;
                                    levelData[nextY][nextX] = 0; // Kunci diambil
                                    gameGrid.children[nextY * gridSize + nextX].innerHTML = ''; // Hapus emoji kunci
                                    playerPos = { x: nextX, y: nextY };
                                    break;
                                case 2: // Bendera (Tujuan)
                                    playerPos = { x: nextX, y: nextY };
                                    updatePlayerPosition();
                                    await sleep(200);
                                    winExecution();
                                    return;
                                case 0: // Kosong
                                case 6: // Lumpur (Aman dilewati)
                                    playerPos = { x: nextX, y: nextY };
                                    break;
                            }
                            break;
                        
                        case 'kiri':
                            playerDir = (playerDir - 1 + 4) % 4;
                            break;
                        
                        case 'kanan':
                            playerDir = (playerDir + 1) % 4;
                            break;
                    }
                    updatePlayerPosition();
                }

                // Selesai eksekusi tapi belum di bendera
                if (levels[currentLevel].grid[playerPos.y][playerPos.x] !== 2) {
                    failExecution("Robot belum sampai di bendera (üèÅ). Coba lagi!");
                }
            }

            /**
             * Menghitung vektor gerak berdasarkan arah
             */
            function getDirectionVector() {
                switch(playerDir) {
                    case 0: return { dx: 0, dy: -1 }; // Atas
                    case 1: return { dx: 1, dy: 0 };  // Kanan
                    case 2: return { dx: 0, dy: 1 };  // Bawah
                    case 3: return { dx: -1, dy: 0 }; // Kiri
                    default: return { dx: 0, dy: 0 };
                }
            }

            /**
             * Mengatur status tombol (aktif/nonaktif)
             */
            function toggleControls(enable) {
                // Tambahkan .btn-gemini ke querySelector
                const buttons = document.querySelectorAll('.btn-command, #btn-run, #btn-reset, .btn-gemini');
                buttons.forEach(btn => {
                    btn.disabled = !enable;
                    btn.style.opacity = enable ? 1 : 0.5;
                    btn.style.cursor = enable ? 'pointer' : 'not-allowed';
                });
            }

            // === 3. FUNGSI UI (MODAL) ===

            function showModal(title, message, isWin) {
                modalTitle.innerText = title;
                modalMessage.innerHTML = message;

                // Reset UI Gemini
                geminiAnalysis.classList.add('hidden');
                analysisText.innerHTML = '';
                btnAnalyzeSolution.disabled = false; // Aktifkan lagi

                if (isWin) {
                    modalTitle.style.color = '#facc15'; // yellow-400
                    btnNextLevel.classList.remove('hidden');
                    btnRetry.classList.add('hidden');
                    btnAnalyzeSolution.classList.remove('hidden'); // Tampilkan tombol analisis
                } else {
                    modalTitle.style.color = '#ef4444'; // red-500
                    btnNextLevel.classList.add('hidden');
                    btnRetry.classList.remove('hidden');
                    btnAnalyzeSolution.classList.add('hidden'); // Sembunyikan tombol analisis
                }
                
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.style.opacity = 1;
                    modalContent.style.opacity = 1;
                    modalContent.style.transform = 'scale(1)';
                }, 10); // Butuh delay kecil untuk transisi
            }

            function hideModal() {
                modal.style.opacity = 0;
                modalContent.style.opacity = 0;
                modalContent.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
            }

            function winExecution() {
                showModal("BERHASIL!", `Kerja bagus! Anda menyelesaikan ${levels[currentLevel].title}.`, true);
            }

            function failExecution(message) {
                showModal("GAGAL!", message, false);
                isExecuting = false; // <-- PERBAIKAN: Tambahkan baris ini
                toggleControls(true); // Aktifkan lagi tombol reset
            }

            // === 4. FUNGSI GEMINI API ===

            /**
             * Fungsi pembungkus untuk memanggil Gemini API dengan exponential backoff
             */
            async function callGeminiAPI(systemPrompt, userPrompt, loadingElement, textElement, buttonElement) {
                if (buttonElement) buttonElement.disabled = true;
                textElement.innerHTML = '';
                loadingElement.classList.remove('hidden');
                // Pastikan parent-nya terlihat
                if (loadingElement.parentElement) {
                    loadingElement.parentElement.classList.remove('hidden');
                }
                
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                
                const payload = {
                    contents: [{ parts: [{ text: userPrompt }] }],
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    },
                };

                let response;
                let retries = 0;
                const maxRetries = 5;
                let waitTime = 1000; // 1 detik

                while (retries < maxRetries) {
                    try {
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.ok) {
                            const result = await response.json();
                            const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                            
                            if (text) {
                                loadingElement.classList.add('hidden');
                                textElement.innerText = text;
                                if (buttonElement) buttonElement.disabled = false;
                                return; // Sukses
                            } else {
                                throw new Error("Respon API tidak valid atau kosong.");
                            }
                        } else if (response.status === 429 || response.status >= 500) {
                            // Throttling or server error, retry
                            retries++;
                            await new Promise(resolve => setTimeout(resolve, waitTime));
                            waitTime *= 2; // Exponential backoff
                        } else {
                            // Error klien lain
                            const errorResult = await response.json();
                            console.error("API Error:", errorResult);
                            throw new Error(errorResult.error?.message || "Gagal memanggil API");
                        }
                    } catch (error) {
                        if (retries >= maxRetries - 1) {
                             // Gagal setelah semua percobaan
                            console.error("Gagal memanggil Gemini API:", error);
                            loadingElement.classList.add('hidden');
                            textElement.innerText = "Maaf, terjadi kesalahan saat menghubungi Gemini. Coba lagi nanti.";
                            if (buttonElement) buttonElement.disabled = false;
                            return;
                        }
                        retries++;
                        await new Promise(resolve => setTimeout(resolve, waitTime));
                        waitTime *= 2;
                    }
                }
            }


            // === 5. EVENT LISTENERS ===

            // Listener tombol perintah
            btnMaju.addEventListener('click', () => addCommand('maju'));
            btnKiri.addEventListener('click', () => addCommand('kiri'));
            btnKanan.addEventListener('click', () => addCommand('kanan'));

            // Listener tombol kontrol
            btnRun.addEventListener('click', executeCommands);
            btnReset.addEventListener('click', resetGame);

            // Listener tombol modal
            btnNextLevel.addEventListener('click', () => {
                hideModal();
                currentLevel++;
                loadLevel(currentLevel); // Muat level berikutnya
            });

            btnRetry.addEventListener('click', () => {
                hideModal();
                resetGame(); // Reset level saat ini
            });
            
            // --- Listener Tombol Gemini ---
            
            // Tombol "Jelaskan Konsep Ini"
            btnExplainConcept.addEventListener('click', () => {
                const level = levels[currentLevel];
                const concept = level.concept;

                const systemPrompt = "Anda adalah seorang guru berpikir komputasional yang ramah untuk anak-anak. Jelaskan konsep yang diberikan dalam Bahasa Indonesia yang sederhana dan ringkas (maksimal 3-4 kalimat). Gunakan satu analogi kehidupan sehari-hari yang mudah dipahami anak-anak.";
                const userPrompt = `Tolong jelaskan konsep "${concept}".`;
                
                callGeminiAPI(
                    systemPrompt, 
                    userPrompt,
                    geminiExplanation.querySelector('.loader'), // Elemen loader
                    explanationText, // Elemen teks
                    btnExplainConcept // Tombol untuk di-disable
                );
            });

            // Tombol "Analisis Solusiku"
            btnAnalyzeSolution.addEventListener('click', () => {
                const level = levels[currentLevel];
                const solution = commandQueue.join(', ');

                const systemPrompt = "Anda adalah seorang analis kode robot yang ahli dan suportif. Pengguna baru saja menyelesaikan level. Berikan umpan balik singkat (1-2 kalimat) dalam Bahasa Indonesia. Fokus pada efisiensi. Jika solusinya bagus, puji. Jika bisa lebih pendek, beri saran perbaikan tanpa memberi jawaban lengkap.";
                const userPrompt = `Saya menyelesaikan level "${level.title}". Solusi saya adalah: ${solution}. Apakah solusi ini sudah efisien atau bisa dipersingkat?`;

                callGeminiAPI(
                    systemPrompt,
                    userPrompt,
                    geminiAnalysis.querySelector('.loader'), // Elemen loader
                    analysisText, // Elemen teks
                    btnAnalyzeSolution // Tombol untuk di-disable
                );
            });
            
            // Penyesuaian ukuran grid saat window di-resize
            window.addEventListener('resize', () => {
                 // Beri jeda sedikit agar layout stabil sebelum render ulang
                setTimeout(() => {
                    loadLevel(currentLevel);
                }, 100);
            });

            // === 6. INISIASI GAME ===
            loadLevel(currentLevel);
        });
    </script>

</body>
</html>



